<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ $.Site.BaseURL }}/media/images/favicon.ico" type="image/X-icon">
    {{ hugo.Generator }}/
    <link rel="stylesheet" href="{{ $.Site.BaseURL }}/presidium.css">
    <title>{{ $.Site.Title }}</title>
</head>
<body>
$.Site.Params.logo
{{ if $.Site.Params.enterprise_enabled }}
    <div data-key="{{ $.Site.Params.enterprise_key }}"
         data-title="{{ $.Site.Title }}"
         id="presidium-enterprise"
         class="presidium-enterprise">
    </div>
{{ end }}

<div id="presidium-navigation">
</div>
<div id="presidium-container" class="container-fluid">
    <div class="row">
        <div id="presidium-content" class="col-lg-10 col-md-12">
            <h1 class="page-title">{{ .Title }}</h1>
            <hr/>
            <section>
                {{ partial "info.html" }}
                {{ block "content" . }}
                {{ end }}
                {{ .Content }}
            </section>
            {{ partial "footer.html" }}
        </div>
        <div class="col-lg-2"></div>
    </div>
</div>

{{ partial "modal.html" }}
<!-- Components -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script> <!-- TODO Z: This will move to Presidium Enterprise JS and included as node module -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script> <!-- TODO Z: This will move to Presidium Enterprise JS and included as node module -->
{{ partial "javascript" . }}
<script>
    window.config = {
        singleSite: false,
        hideProfile: false
    }
    window.presidium.config = {
        name: "Span handbook",
        baseurl:  "{{ relURL "/" }}",
        brandurl:  "",
        repourl:  ""
    }
    window.presidium['versions'] = { siteroot: "{{ relURL "/" }}" };
    window.presidium.tooltips = {};
    window.presidium.tooltips.load = function (data) {};

    var editingPath = null;

    var editorContent = new Map();
    const editorContentPromise = fetch('./editor.json')
        .then(response => response.json())
        .then((data => {
            console.log("content loaded!");
            const articles = data["articles"];
            for(var i = 0; i < articles.length; i++) {
                var articleData = new Map();
                articleData.set("preloadedData", articles[i].editor);
                articleData.set("editorInstance", null);
                editorContent.set(`${articles[i].path}`, articleData);
            }
        }));

    const createEditingPath = function(id) {
        return `editorjs-${id}`;
    }

    const createEditorInstance = function(articleDiv, articlePath, articleData) {
        if (editingPath) {
            // toggle readonly on last article edited
            const editorInstance = editorContent.get(`${editingPath}`).get("editorInstance");
            editorInstance.readOnly.toggle();
        }
        
        // set new article as currently editing
        editingPath = articlePath;

        // check if instance already exists, then just toggle readonly
        const editorInstance = editorContent.get(`${articlePath}`).get("editorInstance");
        if (editorInstance) {
            editorInstance.readOnly.toggle();
            var blocks = document.querySelectorAll(".ce-block__content");
            for(var i = 0; i < blocks.length; i++) {
                blocks[i].style.margin = "unset";
                blocks[i].style.maxWidth = "unset";
            }
            articleDiv.querySelector(".codex-editor__redactor").style.paddingBottom = "unset";
            return;
        }

        articleEditorID = createEditingPath(articlePath);
        articleDiv.id = articleEditorID;
 
        editor = new EditorJS({
            holderId : articleEditorID,
            tools: {
                header: {
                    class: Header,
                    config: {
                        placeholder: 'Enter a header',
                        levels: [2, 3, 4],
                        defaultLevel: 2
                    }
                }
            },
            data: articleData.get("preloadedData"),
            onReady: () => {
                // TODO Z: must be removed, need to figure out how to apply styling to blocks.
                var blocks = document.querySelectorAll(".ce-block__content");
                for(var i = 0; i < blocks.length; i++) {
                    blocks[i].style.margin = "unset";
                    blocks[i].style.maxWidth = "unset";
                }
                articleDiv.querySelector(".codex-editor__redactor").style.paddingBottom = "unset";

                // hide static content of article
                articleDiv.querySelector(".presidium-article-wrapper").style.display = "none";
            }
        });

        editorContent.get(`${articlePath}`).set("editorInstance", editor);
    }

    const clickHandler = function(evt) {
        if (!editorContent) return;

        const articlePath = evt.currentTarget.querySelector(".anchor").getAttribute("data-id");
        const articleData = editorContent.get(`${articlePath}`);

        if (articlePath === editingPath) {
            return;
        }
        createEditorInstance(evt.currentTarget, articlePath, articleData);
    }

    const articlesOnPage = document.querySelectorAll(".article");
    var article = null;
    for(var i = 0; i < articlesOnPage.length; i++) {
        article = articlesOnPage[i];
        article.addEventListener("click", clickHandler)
    }

    window.presidium.menu.load({{ (partial "json-navigation" .) | jsonify | safeJS }}, "presidium-navigation");
    mermaid.initialize({startOnLoad:true});
</script>

{{ if $.Site.Params.enterprise_enabled }}
<script src="{{ $.Site.Params.enterprise_script }}"></script>
{{ end }}

</body>
</html>
