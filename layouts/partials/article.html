{{ $roles := .Params.roles | default "All Roles" }}
{{/* Use title if no slug */}}
{{ $slug := humanize .Params.Title }} {{/* Handles any dashes in the title */}}
{{ $slug = anchorize $slug }}
{{ if .Params.Slug }}
    {{ $slug = .Params.Slug}}
{{ end }}

{{/* Parent slug */}}
{{ $parentSlug := ((humanize .Parent.Params.Title) | default "root") }}
{{ $parentSlug = anchorize $parentSlug }}
{{ if .Parent.Params.Slug }}
    {{ $parentSlug = .Parent.Params.Slug}}
{{ end }}

{{ $type := "parent" }}
{{if not .Data.Pages }}
    {{ $type = "child" }}
{{end}}
{{ $dataId := .Params.id | default .File.Path }}
{{ $pageSlug := (printf "%v-%v" ($parentSlug) $slug )}}
{{ $nestedArticles := .Site.Params.includeNestedArticles | default true }}
{{ $content := 0 }}
{{ if .Content }}
    {{ $content = len .Content }}
{{ end }}

<div class="article {{ $type }}" data-roles="{{ $roles }}" id="{{ $pageSlug }}">
    {{ if or (ne ($content) 0) $nestedArticles }}
    <div class="presidium-article-wrapper">
        <span class="anchor"  id="{{ $slug }}" data-id="{{ $dataId }}"></span>
        {{ if (eq .Parent.Title .Title) }}
            {{/*  No title - For when the main title is the same as the first article  */}}
        {{ else }}
            <div class="article-title" >
                {{ if .Data.Pages }}
                    <h1> {{ .Title }} {{ partial "edit-link.html" }}</h1>
                {{ else }}
                    <h2> {{ .Title }} {{ partial "edit-link.html" }}</h2>
                {{ end }}
                
                <div class="permalink">
                    <a class="link-icon" href="#{{ $slug }}" title="Permalink to this article"></a>
                </div>
            </div>
        {{ end }}

        {{ partial "article-header" . }}

        <article>{{ .Content }}</article>

        {{ if $nestedArticles }}
            {{/* Sort by filename unless there is a missing digit prefix */}}
            {{ $sortByFilename := true}}
            {{ range $name := .Data.Pages }}
                {{/* Find digits with a dash at the start of a filename */}}
                {{ if eq nil (findRE `^\d+-` $name.File.ContentBaseName 1) }}
                    {{/*  Default back to weight if a file is missing the prefix */}}
                    {{ $sortByFilename = false }}  
                {{ end }}
            {{ end }}
            {{ if $sortByFilename }}
                {{/* Sort by file prefix */}}
                {{ range sort .Data.Pages "File.Path" }}
                    {{ partial "article" . }}
                {{ end }}
            {{ else }}
                {{/* Sort by weight otherwise the hugo default */}}
                {{ range .Data.Pages.ByWeight }}
                    {{ partial "article" . }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{ if not .Data.Pages }}
            <hr>
        {{ end }}
    </div>
    {{ end }}
</div>
