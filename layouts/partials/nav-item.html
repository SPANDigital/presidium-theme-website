{{ $childLevel := add .Level 1 }}
{{ $levelCssClasses := dict "1" "level-one" "2" "level-two" "3" "level-three" "4" "level-four" "5" "level-five" "6" "level-six"}}
{{ $cssClass := index $levelCssClasses (string .Level) }}
{{ $currentPage := .CurrentPage}}
{{ $onArticle := eq .CurrentPage.Permalink .NavPage.Parent.Permalink }}
{{ $isAncestor := in .CurrentPage.Permalink .NavPage.Parent.Permalink  }}
{{ $thisArticle := eq .CurrentPage.Permalink .NavPage.Permalink }}
{{ $expanded := or $onArticle $thisArticle}}
{{ $link := "Unset" }}
{{ if $onArticle }}
    {{ $link = (printf "#%v" .NavPage.Params.Slug ) }}
{{ else }}
    {{if not .NavPage.Data.Pages }}
        {{ $link = (printf "%v#%v" .NavPage.Parent.Permalink .NavPage.Params.Slug ) }}
    {{ else }}
        {{ $link = (printf "%v" .NavPage.Permalink) }}
    {{end}}
{{end}}
<li class="menu-parent_{{ .NavPage.Parent.Slug }}{{if $onArticle}} on-article{{end}}"
    {{ if not $isAncestor }}
        aria-expanded="false" style="height: 0px; overflow: hidden;"
    {{ end }}
>
    <a class="menu-row {{ $cssClass }}" data-slug="{{ .NavPage.Slug }}" data-id="{{ .NavPage.File.Filename }}" href="{{ $link }}">
<!--        {{ $expanded }} {{$isAncestor}}  {{ $onArticle }} {{$thisArticle}}-->

        {{ if .NavPage.Data.Pages }}
            <div class="menu-expander" data-toggle="collapse" data-target=".menu-parent_{{ .NavPage.Slug }}" aria-controls=".menu-parent_{{ .NavPage.Slug }}">
                {{ if $isAncestor }}
                    <span class="glyphicon glyphicon-chevron-down glyphicon-toggle"></span>
                {{ else }}
                    <span class="glyphicon glyphicon-chevron-right glyphicon-toggle"></span>
                {{ end }}
            </div>
        {{ end }}
        <div class="menu-title">
            {{ .NavPage.Name }}
        </div>
    </a>

    {{ if and (.NavPage.Data.Pages) }}
        {{ range .NavPage.Data.Pages }}
            {{ partial "nav-item" (dict "CurrentPage" $currentPage "NavPage" . "Level" $childLevel) }}
        {{ end }}
    {{ end }}
</li>
